---
title: "Resouce use in two sympatric species of sea snakes in anthropogenically dominated seascape"
output:
  html_document:
    css: style.css
    df_print: kable
    theme: spacelab
    toc: yes
    toc_float: yes
    toc_depth: 2
    number_sections: yes
subtitle: Analysis for manuscript
Author: Shawn Dsouza
---

# DIfference in distribution and habitat use between _H. curtus_ and _H. shcistosus_

## Mapping sea snake distribution with fisheries survey data

```{r, eval = FALSE, echo = TRUE}
#Calculating sea snake abundance

snakes_den = snakes%>%
  filter(Species == "Hydrophis schistosus" | Species == "Hydrophis curtus",
         Fishing.Location != "", 
         !is.na(Depth.Caught..m.))%>%
  dplyr::select(Species, Fishing.Location, Depth.Caught..m., Date, Boat.Name.Owner, 
         No..of.Hauls, Average.Haul.Duration..Hours., Gear.Type)%>%
  group_by(Gear.Type)%>%
  mutate(n.hauls = ifelse(is.na(No..of.Hauls), 
                         median(No..of.Hauls, na.rm = T), No..of.Hauls),
         haul.time = ifelse(is.na(Average.Haul.Duration..Hours.), 
                         median(Average.Haul.Duration..Hours., na.rm = T),
                         Average.Haul.Duration..Hours.))%>%
  group_by(Date, Boat.Name.Owner)%>%
  summarise(HC = sum(Species == "Hydrophis curtus"),
         HS = sum(Species == "Hydrophis schistosus"),
         effort = last(n.hauls*haul.time),
         Fishing.Location = last(Fishing.Location),
         Depth.Caught..m. = last(Depth.Caught..m.))%>%
  gather(c("HC", "HS"), value = n, key = "Species")%>%
  mutate(CPUE = n/effort)%>%
  drop_na()

#Geocoding sea snake density

snakes_den = snakes_den%>%
  ungroup()%>%
  mutate(Fishing.Location = as.character(Fishing.Location))%>%
  mutate_geocode(location = Fishing.Location)

#Extracting point data from depth and location

library(fuzzyjoin)

#matching funtions for theta join

depth_match <- function(x,y){
  x <- -x
  x <= y+0.5 & x >= y-0.5 #interval for theta matching depth
}

lat_match <- function(x,y){
  x <= y+0.005 & x >= y-0.005 #interval for theta matching latitude
}

snakes_den <- snakes_den%>%
  mutate(depth = Depth.Caught..m.)%>%
  fuzzy_inner_join(y = depth, by = c("depth", "lat"), 
                   match_fun = list(depth = depth_match,
                                    lat = lat_match))%>%
  dplyr::select(Date, Boat.Name.Owner, Species, Fishing.Location, Depth.Caught..m., 
         lon.y, lat.x, CPUE, n)%>%#dplyr::selecting relevant variables
  rename(lon = lon.y,# longitude from fishing location
         lat = lat.x)%>%# latitude from depth data
  distinct(Date, Boat.Name.Owner, Species, Fishing.Location, Depth.Caught..m., .keep_all = T)

write.csv(snakes_den, "./Data/snakes-density.csv")#saved data set to reduce compute time
```

```{r}
# sample size

snakes%>%
  filter(Species == "Hydrophis schistosus" | Species == "Hydrophis curtus",
         Fishing.Location != "", 
         !is.na(Depth.Caught..m.))%>%
  dplyr::select(Species, Fishing.Location, Depth.Caught..m., Date, Boat.Name.Owner, 
         No..of.Hauls, Average.Haul.Duration..Hours., Gear.Type)%>%
  group_by(Gear.Type)%>%
  mutate(n.hauls = ifelse(is.na(No..of.Hauls), #completing vars with median
                         median(No..of.Hauls, na.rm = T), No..of.Hauls),
         haul.time = ifelse(is.na(Average.Haul.Duration..Hours.), 
                         median(Average.Haul.Duration..Hours., na.rm = T),
                         Average.Haul.Duration..Hours.))%>%
  group_by(Gear.Type, Date, Boat.Name.Owner)%>%
  summarise(HC = sum(Species == "Hydrophis curtus"),
         HS = sum(Species == "Hydrophis schistosus"),
         effort = last(n.hauls*haul.time),
         Fishing.Location = last(Fishing.Location),
         Depth.Caught..m. = last(Depth.Caught..m.))%>%
  gather(c("HC", "HS"), value = n, key = "Species")%>%
  mutate(CPUE = n/effort)%>%
  drop_na()%>%
  group_by(Gear.Type)%>%
  summarise(n = n(),
            effort = sum(effort))
```


```{r}
snakes_den <- read.csv("./Data/snakes-density.csv")#saved data set to reduce compute time

#plotting densities

# Calculating sea snake CPUE

den <- snakes_den%>%
  group_by(Species)%>%
  nest()%>%
  mutate(m = map(data, ~map.extract(df = ., var = "n", func = 'sum')),
         mdf = map(m, map.df))%>%
  dplyr::select(mdf)%>%
  unnest()%>%
  spread(Species, layer)

# Mean, sd CPUE

den%>%
  skimr::skim(HC, HS)

#Spatial extent of species

snakes_den%>%
  group_by(Species)%>%
  nest()%>%
  mutate(m = map(data, ~map.extract(df = ., var = "CPUE", func = 'sum')),
         mdf = map(m, map.df))%>%
  dplyr::select(mdf)%>%
  summarise(ext = map(mdf, ~sum(.$layer>0)))%>%
  unnest()
#Function for creating plot for each Gear/Species

int.plot <- function(mdf, gear, name){
  ggmap(base)+
    metR::geom_contour2(data = depth, aes(x = lon, y = lat, z = depth),
                 breaks=seq(-10, -80, -10), colour="black", size = 0.3
                 )+
    metR::geom_text_contour(data = depth, aes(x = lon, y = lat, z = depth), skip = 1,
                            parse = T,check_overlap = T, size = 3)+
    geom_raster(data = mdf, aes(x = x, y = y, fill =layer), alpha = 0.6)+
    coord_quickmap()+
    scale_fill_viridis(name = name, direction = -1)+
    #scale_y_continuous(limits = c(73.1, 73.8))+
    labs(title = gear, x = "Longitude", y = "Latitude")+
      theme(plot.title = element_text(hjust = 0.5, face = "italic"),
            legend.text = element_text(size = 10),
            text = element_text(size = 15))
}

#Plotting distribution

snake_plot <- snakes_den%>%
  mutate(Species = ifelse(Species == "HC", "Hydrophis curtus", "Hydrophis schistosus"))%>%
  group_by(Species)%>%
  nest()%>%
  mutate(m = map(data, ~map.extract(df = ., var = "CPUE", func = 'sum')),
         mdf = map(m, map.df),
         plot = map2(mdf, Species, ~int.plot(mdf = ., Species, name = "CPUE")))%>%
  gridExtra::grid.arrange(grobs = .$plot, ncol = 2)

ggsave(snake_plot, filename = "./Figures/figure1.tiff", width = 8, height = 4.5, dpi = 300)

```

- Why does the join reduce from 101 -> 92
- Why is _H. curtus_ only found around and off Malvan?

Do _H. schistosus_ and _H.curtus_ partition the coastal habitat along the depth axis?

## Summarising depth use by species

```{r}
# Calculating mean depth in cell

dep <- depth%>%
  nest()%>%
  mutate(m = map(data, ~map.extract(df = ., var = "depth", func = mean)),
         mdf = map(m, map.df))%>%
  dplyr::select(mdf)%>%
  unnest()%>%
  rename(mean.depth = layer)

#Calculating relative abaundance of sea snakes in each cell

fi_den<- inner_join(fi, den, by = c("x", "y"))%>%
  inner_join(dep, by = c("x", "y"))%>%
  mutate(rel.prop = HC/(HC+HS))

# Relative proportion of H. curtus with depth

fi_den%>%
  gather(c("HS", "HC"), key = sp, value = CPUE)%>%
  filter(CPUE>0)%>%
  group_by(sp)%>%
  skimr::skim(mean.depth)%>%
  skimr::yank("numeric")

```

## Spatial segregation by species

```{r}
fi_den%>%
  summarise(ttl.ext = sum(HC>0 | HS>0),
            ovrlp = sum(HC > 0 & HS > 0),
            rel.ovlp = ovrlp/ttl.ext)
```


## Modelling depth use by species

```{r}
#t-test for cell depth
fi_den%>%
  gather(c("HS", "HC"), key = sp, value = CPUE)%>%
  filter(CPUE>0)%>%
  dplyr::select(sp, mean.depth)%>%
  nest()%>%
  mutate(mod = map(data, ~t.test(mean.depth ~ sp, data = .)),
         sumry = map(mod, broom::tidy),
         d = map(data, ~lsr::cohensD(mean.depth ~ sp, data = .)))%>%
  dplyr::select(sumry, d)%>%
  unnest()%>%
  dplyr::select(estimate:p.value, d)

#testing effect of cell depth on relative abundance

fi_den%>%
  gather(c("HS", "HC"), key = sp, value = CPUE)%>%
  mutate(rel.prop = ifelse(sp == "HS", 1 - rel.prop, rel.prop),
         mean.depth = -mean.depth)%>%
  dplyr::select(sp, rel.prop, mean.depth)%>%
  group_by(sp)%>%
  nest()%>%
  mutate(prop_dep = map(data, ~lm(rel.prop ~ mean.depth, data = .)),
         sumry = map(prop_dep, broom::tidy),
         stat = map(prop_dep, broom::glance))%>%
  dplyr::select(sumry, stat)%>%
  unnest()%>%
  dplyr::select(sp:p.value, adj.r.squared)
  
```

After controling for effect of gear type with a mixed effect model. Depth caught still varies significantly with species.

Hence, prefered habitat in terms of depth may vary bewtween _H. curtus_ and _H. schistosus_

