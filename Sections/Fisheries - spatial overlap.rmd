---
  title: "Resouce use in two sympatric species of sea snakes in anthropogenically dominated seascape"
output:
  html_document:
  css: style.css
df_print: kable
theme: spacelab
toc: yes
toc_float: yes
toc_depth: 2
number_sections: yes
subtitle: FIsheries - spatial overlap
Author: Shawn Dsouza
---

# Does fishing intensity affect the distribution of *H. curtus* and *H. schistosus*?

```{r}
dep_int <- read.csv("./data/Fishing intensity_dep.csv")

depth <- read.csv("./data/sindhudurg depth.csv")

snakes_den <- read.csv("./data/snakes-density.csv")
```


```{r}
library(sp)
library(raster)

ext <- raster::raster("./Data/sampling_extent.tif")

#Function for extracting intensity/abundance from points

map.extract <- function(df, var, func){
  
  foo <- df
  
  #Converting to SpatialPointsdf
  
  coordinates(foo) <- ~lon + lat
  
  proj4string(foo) <- CRS("+init=epsg:4326")#setting projection to WGS 84 (lon/lat)
  
  foo <- spTransform(foo, CRSobj = CRS("+init=epsg:3857"))#using spherical mercator
  
  #assigning intensity values to raster
  
  m <- rasterize(foo, ext, fun = func, field=var, update=TRUE)
} 

# Function converting the raster into df for plotting

map.df <- function(m){
  ##Reprojecting int_map
  
  r <- projectRaster(m, crs = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
  
  ## Creating dataframe
  
  mdf <- as.data.frame(r, xy = T)%>%drop_na()
}

```

```{r}
#Calculating fishing intensity

fi <- dep_int%>%
  group_by(Gear.Type)%>%
  nest()%>%
  mutate(m = map(data, ~map.extract(df = ., var = "effort", func = 'sum')),
         mdf = map(m, map.df))%>%
  dplyr::select(mdf)%>%
  unnest()%>%
  spread(Gear.Type, layer)
#rename(intensity = layer)

# Calculating sea snake CPUE

den <- snakes_den%>%
  group_by(Species)%>%
  nest()%>%
  mutate(m = map(data, ~map.extract(df = ., var = "n", func = 'sum')),
         mdf = map(m, map.df))%>%
  dplyr::select(mdf)%>%
  unnest()%>%
  spread(Species, layer)

# Calculating mean depth in cell

dep <- depth%>%
  nest()%>%
  mutate(m = map(data, ~map.extract(df = ., var = "depth", func = mean)),
         mdf = map(m, map.df))%>%
  dplyr::select(mdf)%>%
  unnest()%>%
  rename(mean.depth = layer)

#Calculating relative abaundance of sea snakes

fi_den<- inner_join(fi, den, by = c("x", "y"))%>%
  inner_join(dep, by = c("x", "y"))%>%
  mutate(rel.prop = HC/(HC+HS))
#filter(intensity>0 | HC > 0 | HS >0)

#Clasifiying intesity

#fi.qntls <- quantile(fi_den$intensity, 
#                       probs = c(0, 0.25,.75, 1))

#fi_den <- fi_den%>%
#  mutate(fi.class = cut(intensity, breaks = c(0, 50, 100, 200), 
#                       labels = c("low", "medium", "high") ))


```

## Spatial overlap between fisheries and sea snakes

```{r}
sp.ovlp <- fi_den%>%
  gather(c("HS", "HC"), key = sp, value = CPUE)%>%
  gather(c("GillNet", "Trawler"), key = gear, value = intensity)%>%
  group_by(gear, sp)%>%
  summarise(overlap = sum(CPUE > 0 & intensity > 0),
            extent.sp = sum(CPUE>0),
            rel.ovlp = overlap/extent.sp)

knitr::kable(sp.ovlp)
```


```{r}
sp.ovlp%>%
  group_by(sp)%>%
  nest()%>%
  mutate(ptest = map(data, ~prop.test(.$overlap, .$extent.sp)),
         sumry = map(ptest, broom::tidy),
         h = map(sumry, ~pwr::ES.h(.$estimate2, .$estimate1)))%>%
  select(sumry, h)%>%
  unnest()%>%
  dplyr::select(sp:p.value, h)
```


## Variation in relative proportion of HC with fishing intensity

```{r}
int_dist <- lm(rel.prop ~ GillNet + Trawler + mean.depth, data = fi_den)

tidy(int_dist)

glance(int_dist)%>%
  dplyr::select(adj.r.squared, AIC)

car::Anova(int_dist)

fi_den%>%
  gather(c('GillNet', 'Trawler'), key = "Gear.Type", value =  "intensity")%>%
  ggplot(aes(intensity, rel.prop))+
  geom_point()+
  geom_smooth(method = "lm")+
  scale_y_log10()+
  labs(x = "Fishing intensity", y = "Relative proportion of H.curtus")+
  facet_wrap(~Gear.Type, scales = "free_x")
```
