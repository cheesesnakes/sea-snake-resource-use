---
  title: "Resouce use in two sympatric species of sea snakes in anthropogenically dominated seascape"
output:
  html_document:
  css: style.css
df_print: kable
theme: spacelab
toc: yes
toc_float: yes
toc_depth: 2
number_sections: yes
subtitle: Trophic niche
Author: Shawn Dsouza
---
```{r}
# libraries

library(tidyverse)

#snakes data

snakes <- read.csv("./data/Sea-snakes_fish-dep_2018-19_070220.csv")
```

# DIfference in diet between *H. curtus* and *H. schsitosus*

## No. of samples collected by sea snake species

```{r}
snakes%>%
  filter(Species == "Hydrophis curtus" | Species == "Hydrophis schistosus")%>%
  group_by(Species)%>%
  summarise(N = n(),
            n = sum((Gut.Content) == "Yes"),
            n_male = sum((Gut.Content) == "Yes" & Sex == "Male"),
            n_female = sum((Gut.Content) == "Yes" & Sex == "Female"),
            prop = N/793)
```

A very low proportion of inviduals had gut content present at the time of sampling. Sampling accross species and sexes may be adequate for comparison.

## Proportion of unidentified specimens

```{r}
gc = read.csv("./Data/Sea_snakes_gut_content_2018-19.csv")%>%
  filter(Source == "Gut content")

gc%>%
  filter(Source == "Gut content")%>%
  summarise(N_sp = length(unique(Prey.Species)),
            N_fam = length(unique(Prey.Family)),
            unid_sp = sum(Prey.Species == "Unidentified" | Prey.Species == "", na.rm = T)/n(),
            unid_fam = sum(Prey.Family == "Unidentified" | Prey.Family == "", na.rm = T)/n())
```

A large portion of gut content specimens were unidentifiable. This is an unavoidable consquence of VGCA.


## Diverisity of prey families found in gut content

```{r}
library(vegetarian)

#Creating data martix

fam_vegan = gc%>%
  filter(Source == "Gut content")%>%
  filter(Prey.Family != "Unidentified")%>%
  group_by(Snake.Species, Prey.Family)%>%
  summarise(n = n())%>%
  group_by(Snake.Species)%>%
  mutate(t = sum(n))%>%
  group_by(Snake.Species, Prey.Family)%>%
  summarise(p = n/t)%>%
  spread(Prey.Family, p, fill = 0)%>%
  column_to_rownames("Snake.Species")

#Richness

gc%>%
  filter(Snake.Species == "Hydrophis schistosus" | Snake.Species == "Hydrophis curtus",
         Prey.Species != "Unidentified")%>%
  group_by(Snake.Species)%>%
  summarise(Prey.Species.Richness = length(unique(Prey.Species)))

#Alpha Diversity

data.frame(
  hs = d(fam_vegan[-1,], "alpha", boot = T),
  hc = d(fam_vegan[-2,], "alpha", boot = T)
)

#Beta diverisity
gc%>%
  filter(Snake.Species == "Hydrophis schistosus" | Snake.Species == "Hydrophis curtus",
         Prey.Species != "Unidentified")%>%
  group_by(Prey.Species)%>%
  summarise(N_pred = length(unique(Snake.Species)))%>%
  ungroup()%>%
  summarise(Overlap = sum(N_pred>1))

gc%>%
  filter(Prey.Species != "Unidentified")%>%
  group_by(Snake.Species, Prey.Species)%>%
  summarise(n = n())%>%
  group_by(Snake.Species)%>%
  mutate(N = sum(n))%>%
  group_by(Snake.Species, Prey.Species)%>%
  summarise(p = n/N)%>%
  spread(Snake.Species, p, fill = 0)%>%
  rename("HC" = 'Hydrophis curtus', "HS" = 'Hydrophis schistosus')%>%
  mutate(P = abs(HC - HS))%>%
  summarise(D = 1 - 0.5*sum(P)) 

similarity(fam_vegan, q = 2, boot = T)

#Percentage of tetrodontids
gc%>%
  filter(Prey.Species != "", Prey.Species != "Unidentified",
         Prey.Family != "", Prey.Family != "Unidentified")%>%
  filter(Snake.Species == "Hydrophis schistosus" | Snake.Species == "Hydrophis curtus")%>%
  group_by(Snake.Species)%>%
  mutate(N = n())%>%
  group_by(Snake.Species, Prey.Family, Prey.Species)%>%
  summarise(N = last(N),
            Perc = n()*100/N)%>%
  write.csv(file = "prey list.csv")

```
## List of sea snake prey species

```{r}
gc%>%
  filter(Snake.Species != "")%>%
  group_by(Snake.Species, Prey.Family, Prey.Species)%>%
  summarise(Percentage = n())
```

## Relative abundance of prey families in sea snake gut content

```{r}
gc%>%
  filter(Snake.Species == "Hydrophis schistosus" | Snake.Species == "Hydrophis curtus",
         Prey.Family != "", Prey.Family != "Unidentified")%>%
  ggplot(aes(Prey.Family, fill = Snake.Species))+
  geom_bar(aes(y = ..prop.., group = Snake.Species), stat = "count",
           position = position_dodge(preserve = "single"), color = "black")+
  labs(x =" Prey Family", y = "Relative proportion")+
  scale_y_continuous(expand = c(0,0), trans = )+
  scale_fill_brewer(palette = "Greys")+
  theme_minimal()+
  theme(legend.position = "top", axis.text.x = element_text(angle = 45, hjust = 1), 
        text = element_text(size = 20),
        legend.text = element_text(face = "italic"))

```

## Diverisity of prey families found in gut content

```{r}
library(vegetarian)
library(vegan)

#Creating data martix

fam_vegan = gc%>%
  filter(Prey.Family != "Unidentified")%>%
  group_by(Snake.Species, Prey.Family)%>%
  summarise(n = n())%>%
  spread(Prey.Family, n, fill = 0)%>%
  column_to_rownames("Snake.Species")

#Richness

gc%>%
  filter(Snake.Species == "Hydrophis schistosus" | Snake.Species == "Hydrophis curtus",
         Prey.Family != "Unidentified")%>%
  group_by(Snake.Species)%>%
  summarise(Prey.Family.Richness = length(unique(Prey.Family)))

#Alpha Diversity
data.frame(
  hs = d(fam_vegan[-1,], "alpha", boot = T),
  hc = d(fam_vegan[-2,], "alpha", boot = T)
)

renyi(fam_vegan, hill = T, scales = c(0,1,2))

library(hilldiv)

# splitting data by gut samples

fam_hilldiv <- gc%>%
  filter(Prey.Family != "Unidentified", Prey.Family !="", Field.Code != "")%>%
  group_by(Field.Code, Prey.Family)%>%
  summarise(n = n())%>%
  spread(Field.Code, n, fill = 0)%>%
  ungroup()%>%
  column_to_rownames("Prey.Family")

fam_hilldiv <- as.data.frame(fam_hilldiv)  

# sample ids and species

gc_samples <- gc%>%
  filter(Prey.Family != "Unidentified", Prey.Family !="", Field.Code != "")%>%
  dplyr::select(Field.Code, Snake.Species)%>%
  distinct()%>%
  rename(Sample = Field.Code,
         Species = Snake.Species)

# testing difference between species

#div_test(countable = tss(fam_hilldiv), hierarchy = gc_samples, qvalue = 1)

```

## Overlap in prey of _H. curtus_ and _H. schsitosus_

```{r}
#Beta diverisity
gc%>%
  filter(Snake.Species == "Hydrophis schistosus" | Snake.Species == "Hydrophis curtus",
         Prey.Family != "Unidentified")%>%
  group_by(Prey.Family)%>%
  summarise(N_pred = length(unique(Snake.Species)))%>%
  ungroup()%>%
  summarise(Overlap = sum(N_pred>1))

similarity(fam_vegan, q = 2, boot = T)


library(vegan)

fam_simboo <- gc%>%
  filter(Prey.Family != "Unidentified", Prey.Family !="", Field.Code != "")%>%
  group_by(Snake.Species, Field.Code, Prey.Family)%>%
  summarise(n = n())%>%
  spread(Prey.Family, n, fill = 0)%>%
  ungroup()

set.seed(2)

permanova_sp <- adonis2(fam_simboo[,3:length(fam_simboo)] ~ fam_simboo$Snake.Species,
                     data = fam_simboo[,1])

broom::tidy(permanova_sp)
```

## Prey preference

```{r}
#Percentage of tetrodontids
IRI <- gc%>%
  filter(Prey.Family != "")%>%
  filter(Snake.Species == "Hydrophis schistosus" | Snake.Species == "Hydrophis curtus")%>%
  group_by(Snake.Species)%>%
  mutate(Fr = length(unique(Field.Code)), # total number of snakes sampled
         W = sum(Weight..g., na.rm = T), # total weight of prey sampled
         N = n())%>% # total number of prey sampled
  group_by(Snake.Species, Prey.Family)%>%
  summarise(f = length(unique(Field.Code)), # number snakes in which prey family occured
            Fr = last(Fr),
            w = sum(Weight..g., na.rm = T), # weight of prey family
            W = last(W),
            n = n(), # number of individuals of prey family
            N = last(N))%>%
  group_by(Snake.Species, Prey.Family)%>%
  summarise(per.F = f*100/Fr,
            per.W = w*100/W,
            per.N = n*100/N, 
            IRI = (per.N + per.W)*per.F)%>%
  group_by(Snake.Species)%>%
  arrange(desc(IRI))%>%
  mutate(rank = 1:n())

knitr::kable(IRI)
```

```{r}
IRI%>%
  ggplot(aes(Prey.Family, IRI, fill = Snake.Species))+
  geom_col(col = "black", position = position_dodge(preserve = "single"))+
  scale_y_sqrt(name = "IRI (sq.rt.)")+
  scale_fill_brewer(palette = "Greys")+
  theme(axis.text.x = element_text(hjust = 1, angle = 60),
        legend.text = element_text(face = "italic"))

```

## Selectivity of prey sizes

```{r}
# summary
gc%>%
  filter(Snake.Species == "Hydrophis schistosus" | Snake.Species == "Hydrophis curtus",
         Condition < 2)%>%
  group_by(Snake.Species)%>%
  skimr::skim(Maximum.Body.Girth..cm.)%>%
  skimr::yank("numeric")%>%
  dplyr::select(Snake.Species:p100)


# testing diff max prey width by species

gc%>%
  filter(Snake.Species == "Hydrophis schistosus" | Snake.Species == "Hydrophis curtus",
         Condition < 3, !is.na(Maximum.Body.Girth..cm.))%>%
  dplyr::select(Snake.Species, Maximum.Body.Girth..cm.)%>%
  droplevels()%>%
  nest()%>%
  mutate(test = map(data, ~t.test(Maximum.Body.Girth..cm. ~ Snake.Species, data = .)),
         sumry = map(test, broom::tidy),
         d = map(data, ~lsr::cohensD(Maximum.Body.Girth..cm. ~ Snake.Species, data = .)))%>%
  dplyr::select(sumry, d)%>%
  unnest()%>%
  dplyr::select(estimate:p.value, d)
```

